<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self';"
    />
    <title>CD48 Coincidence Counter</title>
    <style>
      :root {
        --bg-color: #0f0f1e;
        --bg-gradient: linear-gradient(
          135deg,
          #0f0f1e 0%,
          #1a1a2e 50%,
          #16213e 100%
        );
        --card-bg: #1a1f3a;
        --card-bg-hover: #1f2542;
        --accent: #0f3460;
        --accent-light: #1a4a7a;
        --highlight: #e94560;
        --highlight-dark: #d63853;
        --text: #eee;
        --text-muted: #888;
        --success: #4ade80;
        --warning: #fbbf24;
        --info: #3b82f6;
        --shadow: rgba(0, 0, 0, 0.3);
        --glow: rgba(233, 69, 96, 0.3);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* Skip link for keyboard accessibility */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: var(--highlight);
        color: white;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 0 0 4px 0;
        z-index: 1000;
        font-weight: 500;
      }

      .skip-link:focus {
        top: 0;
      }

      /* Focus indicators for accessibility */
      button:focus-visible,
      input:focus-visible,
      select:focus-visible,
      a:focus-visible {
        outline: 3px solid var(--highlight);
        outline-offset: 2px;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: var(--bg-gradient);
        background-attachment: fixed;
        color: var(--text);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(
          135deg,
          var(--highlight) 0%,
          var(--info) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
      }

      .subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
      }

      .status-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--highlight);
      }

      .status-dot.connected {
        background: var(--success);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--highlight);
        color: white;
      }

      .btn-primary:hover {
        background: #d63853;
      }

      .btn-secondary {
        background: var(--accent);
        color: white;
      }

      .btn-secondary:hover {
        background: #1a4a7a;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 16px var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px var(--shadow);
      }

      .card h2 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .counts-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .count-item {
        background: var(--accent);
        padding: 15px 10px;
        border-radius: 8px;
        text-align: center;
        transition: all 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .count-item:hover {
        background: var(--accent-light);
        transform: scale(1.05);
        box-shadow: 0 4px 12px var(--glow);
      }

      .count-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 5px;
      }

      .count-value {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'Monaco', 'Menlo', monospace;
      }

      .count-rate {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .controls-grid {
        display: grid;
        gap: 15px;
      }

      .control-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-row label {
        min-width: 120px;
        color: var(--text-muted);
      }

      input[type='range'] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: var(--accent);
        appearance: none;
      }

      input[type='range']::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--highlight);
        cursor: pointer;
      }

      input[type='number'] {
        width: 80px;
        padding: 8px;
        border: 1px solid var(--accent);
        border-radius: 4px;
        background: var(--bg-color);
        color: var(--text);
        font-size: 14px;
      }

      select {
        padding: 8px 12px;
        border: 1px solid var(--accent);
        border-radius: 4px;
        background: var(--bg-color);
        color: var(--text);
        font-size: 14px;
      }

      .value-display {
        min-width: 60px;
        text-align: right;
        font-family: monospace;
      }

      .log {
        background: var(--bg-color);
        border-radius: 8px;
        padding: 15px;
        height: 200px;
        overflow-y: auto;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        line-height: 1.6;
      }

      .log-entry {
        margin-bottom: 4px;
      }

      .log-entry.error {
        color: var(--highlight);
      }

      .log-entry.success {
        color: var(--success);
      }

      .log-entry .timestamp {
        color: var(--text-muted);
      }

      .device-info {
        display: grid;
        gap: 8px;
        font-size: 14px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
      }

      .info-label {
        color: var(--text-muted);
      }

      .info-value {
        font-family: monospace;
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .rate-display {
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        padding: 20px;
        font-family: monospace;
      }

      .rate-unit {
        font-size: 1rem;
        color: var(--text-muted);
      }

      .browser-warning {
        background: var(--warning);
        color: #000;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
      }

      .hidden {
        display: none !important;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 0;
      }

      .tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .tab:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.05);
      }

      .tab.active {
        color: var(--highlight);
        border-bottom-color: var(--highlight);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Chart */
      .chart-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 16px var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.05);
        margin-bottom: 20px;
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .chart-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .chart-wrapper {
        position: relative;
        height: 400px;
        background: var(--bg-color);
        border-radius: 8px;
        padding: 15px;
      }

      .channel-selector {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .channel-chip {
        padding: 6px 12px;
        border-radius: 16px;
        border: 2px solid var(--accent);
        background: transparent;
        color: var(--text);
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .channel-chip:hover {
        border-color: var(--accent-light);
        background: rgba(255, 255, 255, 0.05);
      }

      .channel-chip.active {
        border-color: var(--highlight);
        background: var(--highlight);
        color: white;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background: var(--accent);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .stat-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: monospace;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        color: var(--text-muted);
        font-size: 14px;
      }

      footer a {
        color: var(--highlight);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container">
      <header role="banner">
        <h1>CD48 Coincidence Counter</h1>
        <p class="subtitle">Web Serial Interface for Red Dog Physics CD48</p>
      </header>

      <div
        id="browserWarning"
        class="browser-warning hidden"
        role="alert"
        aria-live="polite"
      >
        Web Serial API is not supported in your browser. Please use Chrome 89+
        or Edge 89+.
      </div>

      <div class="status-bar" role="region" aria-label="Connection status">
        <div class="status-indicator">
          <div
            id="statusDot"
            class="status-dot"
            role="status"
            aria-label="Connection indicator"
          ></div>
          <span id="statusText" aria-live="polite" aria-atomic="true"
            >Disconnected</span
          >
        </div>
        <button
          id="connectBtn"
          class="btn btn-primary"
          onclick="toggleConnection()"
          aria-label="Connect to CD48 device"
          aria-describedby="statusText"
        >
          Connect
        </button>
      </div>

      <nav class="tabs" role="tablist" aria-label="Main navigation">
        <button
          class="tab active"
          onclick="switchTab('monitor')"
          role="tab"
          aria-selected="true"
          aria-controls="monitor-panel"
          id="monitor-tab"
        >
          Monitor
        </button>
        <button
          class="tab"
          onclick="switchTab('tracking')"
          role="tab"
          aria-selected="false"
          aria-controls="tracking-panel"
          id="tracking-tab"
        >
          Time Series
        </button>
      </nav>

      <main id="main-content">
        <div
          id="monitorTab"
          class="tab-content active"
          role="tabpanel"
          aria-labelledby="monitor-tab"
        >
          <div class="grid">
            <!-- Counts Display -->
            <section class="card" aria-labelledby="counts-heading">
              <h2 id="counts-heading">Channel Counts</h2>
              <div
                class="counts-grid"
                id="countsGrid"
                role="region"
                aria-live="polite"
                aria-atomic="false"
              >
                <div class="count-item">
                  <div class="count-label">Ch0 (A)</div>
                  <div class="count-value" id="count0">-</div>
                  <div class="count-rate" id="rate0"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch1 (B)</div>
                  <div class="count-value" id="count1">-</div>
                  <div class="count-rate" id="rate1"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch2 (C)</div>
                  <div class="count-value" id="count2">-</div>
                  <div class="count-rate" id="rate2"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch3 (D)</div>
                  <div class="count-value" id="count3">-</div>
                  <div class="count-rate" id="rate3"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch4 (A+B)</div>
                  <div class="count-value" id="count4">-</div>
                  <div class="count-rate" id="rate4"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch5 (A+C)</div>
                  <div class="count-value" id="count5">-</div>
                  <div class="count-rate" id="rate5"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch6 (A+D)</div>
                  <div class="count-value" id="count6">-</div>
                  <div class="count-rate" id="rate6"></div>
                </div>
                <div class="count-item">
                  <div class="count-label">Ch7 (B+C+D)</div>
                  <div class="count-value" id="count7">-</div>
                  <div class="count-rate" id="rate7"></div>
                </div>
              </div>
              <div style="margin-top: 15px">
                <button
                  class="btn btn-secondary"
                  onclick="clearCounts()"
                  id="clearBtn"
                  disabled
                  aria-label="Clear all channel counts"
                >
                  Clear Counts
                </button>
                <label style="margin-left: 15px">
                  <input
                    type="checkbox"
                    id="autoRefresh"
                    onchange="toggleAutoRefresh()"
                    aria-label="Enable automatic count refresh every second"
                  />
                  Auto-refresh (1s)
                </label>
              </div>
            </section>

            <!-- Controls -->
            <section class="card" aria-labelledby="controls-heading">
              <h2 id="controls-heading">Controls</h2>
              <div
                class="controls-grid"
                role="group"
                aria-label="Device controls"
              >
                <div class="control-row">
                  <label for="triggerSlider">Trigger Level</label>
                  <input
                    type="range"
                    id="triggerSlider"
                    min="0"
                    max="255"
                    value="50"
                    oninput="updateTriggerDisplay()"
                    onchange="setTriggerLevel()"
                    aria-describedby="triggerValue"
                    aria-label="Trigger level voltage, 0 to 4.08 volts"
                  />
                  <span
                    class="value-display"
                    id="triggerValue"
                    aria-live="polite"
                    >0.80 V</span
                  >
                </div>
                <div class="control-row">
                  <label for="impedanceSelect">Impedance</label>
                  <select
                    id="impedanceSelect"
                    onchange="setImpedance()"
                    aria-label="Input impedance selection"
                  >
                    <option value="highz">High-Z</option>
                    <option value="50ohm">50 Ohm</option>
                  </select>
                </div>
                <div class="control-row">
                  <label for="dacSlider">DAC Output</label>
                  <input
                    type="range"
                    id="dacSlider"
                    min="0"
                    max="255"
                    value="0"
                    oninput="updateDacDisplay()"
                    onchange="setDacVoltage()"
                    aria-describedby="dacValue"
                    aria-label="DAC output voltage, 0 to 4.08 volts"
                  />
                  <span class="value-display" id="dacValue" aria-live="polite"
                    >0.00 V</span
                  >
                </div>
                <div class="button-group" style="margin-top: 10px">
                  <button
                    class="btn btn-secondary"
                    onclick="testLeds()"
                    id="ledBtn"
                    disabled
                    aria-label="Test device LED indicators"
                  >
                    Test LEDs
                  </button>
                  <button
                    class="btn btn-secondary"
                    onclick="refreshSettings()"
                    id="settingsBtn"
                    disabled
                    aria-label="Refresh device settings"
                  >
                    Refresh Settings
                  </button>
                </div>
              </div>
            </section>

            <!-- Device Info -->
            <section class="card" aria-labelledby="device-info-heading">
              <h2 id="device-info-heading">Device Information</h2>
              <div
                class="device-info"
                id="deviceInfo"
                role="region"
                aria-label="Device status information"
              >
                <div class="info-row">
                  <span class="info-label">Firmware</span>
                  <span class="info-value" id="firmware" aria-live="polite"
                    >-</span
                  >
                </div>
                <div class="info-row">
                  <span class="info-label">Status</span>
                  <span class="info-value" id="deviceStatus" aria-live="polite"
                    >Not connected</span
                  >
                </div>
                <div class="info-row">
                  <span class="info-label">Overflow</span>
                  <span class="info-value" id="overflow" aria-live="polite"
                    >-</span
                  >
                </div>
              </div>
            </section>

            <!-- Log -->
            <section class="card" aria-labelledby="activity-log-heading">
              <h2 id="activity-log-heading">Activity Log</h2>
              <div
                class="log"
                id="log"
                role="log"
                aria-live="polite"
                aria-atomic="false"
                aria-label="Application activity and status messages"
              ></div>
            </section>
          </div>
        </div>

        <div
          id="trackingTab"
          class="tab-content"
          role="tabpanel"
          aria-labelledby="tracking-tab"
        >
          <div class="chart-container">
            <div class="chart-header">
              <h2 style="margin: 0">Count Rate vs Time</h2>
              <div class="chart-controls">
                <select
                  id="timeWindow"
                  onchange="updateTimeWindow()"
                  aria-label="Select chart time window"
                >
                  <option value="60">Last 1 min</option>
                  <option value="300" selected>Last 5 min</option>
                  <option value="600">Last 10 min</option>
                  <option value="1800">Last 30 min</option>
                  <option value="3600">Last 1 hour</option>
                </select>
                <button
                  class="btn btn-secondary"
                  onclick="clearHistory()"
                  aria-label="Clear chart history data"
                >
                  Clear History
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="exportData()"
                  aria-label="Export data to CSV file"
                >
                  Export CSV
                </button>
              </div>
            </div>
            <div class="channel-selector" id="channelSelector">
              <button
                class="channel-chip active"
                data-channel="0"
                onclick="toggleChannel(0)"
                aria-label="Toggle Channel 0 visibility"
                aria-pressed="true"
              >
                Ch0 (A)
              </button>
              <button
                class="channel-chip active"
                data-channel="1"
                onclick="toggleChannel(1)"
                aria-label="Toggle Channel 1 visibility"
                aria-pressed="true"
              >
                Ch1 (B)
              </button>
              <button
                class="channel-chip active"
                data-channel="2"
                onclick="toggleChannel(2)"
                aria-label="Toggle Channel 2 visibility"
                aria-pressed="true"
              >
                Ch2 (C)
              </button>
              <button
                class="channel-chip active"
                data-channel="3"
                onclick="toggleChannel(3)"
                aria-label="Toggle Channel 3 visibility"
                aria-pressed="true"
              >
                Ch3 (D)
              </button>
              <button
                class="channel-chip"
                data-channel="4"
                onclick="toggleChannel(4)"
                aria-label="Toggle Channel 4 visibility"
                aria-pressed="false"
              >
                Ch4 (A+B)
              </button>
              <button
                class="channel-chip"
                data-channel="5"
                onclick="toggleChannel(5)"
                aria-label="Toggle Channel 5 visibility"
                aria-pressed="false"
              >
                Ch5 (A+C)
              </button>
              <button
                class="channel-chip"
                data-channel="6"
                onclick="toggleChannel(6)"
                aria-label="Toggle Channel 6 visibility"
                aria-pressed="false"
              >
                Ch6 (A+D)
              </button>
              <button
                class="channel-chip"
                data-channel="7"
                onclick="toggleChannel(7)"
                aria-label="Toggle Channel 7 visibility"
                aria-pressed="false"
              >
                Ch7 (B+C+D)
              </button>
            </div>
            <div class="chart-wrapper">
              <canvas id="rateChart"></canvas>
            </div>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Data Points</div>
              <div class="stat-value" id="totalPoints">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Recording Duration</div>
              <div class="stat-value" id="duration">0s</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Average Rate (Ch0)</div>
              <div class="stat-value" id="avgRate">0 Hz</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Peak Rate (Ch0)</div>
              <div class="stat-value" id="peakRate">0 Hz</div>
            </div>
          </div>
        </div>
      </main>

      <footer role="contentinfo">
        <p>
          <a
            href="https://github.com/OpenPhysics/pycd48"
            target="_blank"
            rel="noopener noreferrer"
            >pycd48</a
          >
          |
          <a
            href="https://www.reddogphysics.com/cd48.html"
            target="_blank"
            rel="noopener noreferrer"
            >CD48 Hardware</a
          >
        </p>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="cd48.js"></script>
    <script>
      // Global state
      let cd48 = null;
      let autoRefreshInterval = null;
      let lastCounts = null;
      let lastTime = null;

      // Time series tracking
      let trackingData = {
        timestamps: [],
        rates: Array(8)
          .fill(null)
          .map(() => []),
        counts: Array(8)
          .fill(null)
          .map(() => []),
      };
      let chart = null;
      let visibleChannels = [0, 1, 2, 3]; // Default visible channels
      let timeWindow = 300; // seconds
      let trackingInterval = null;

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        if (!CD48.isSupported()) {
          document.getElementById('browserWarning').classList.remove('hidden');
          document.getElementById('connectBtn').disabled = true;
        }
        updateTriggerDisplay();
        updateDacDisplay();
        initChart();
        log('Ready. Click Connect to start.');
      });

      // Logging
      function log(message, type = '') {
        const logEl = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Connection
      async function toggleConnection() {
        if (cd48 && cd48.isConnected()) {
          await disconnect();
        } else {
          await connect();
        }
      }

      async function connect() {
        try {
          log('Connecting to CD48...');
          cd48 = new CD48();
          await cd48.connect();

          document.getElementById('statusDot').classList.add('connected');
          document.getElementById('statusText').textContent = 'Connected';
          document.getElementById('connectBtn').textContent = 'Disconnect';
          document.getElementById('deviceStatus').textContent = 'Connected';

          enableControls(true);
          log('Connected successfully!', 'success');

          // Get device info
          const version = await cd48.getVersion();
          document.getElementById('firmware').textContent = version;
          log(`Firmware: ${version}`);

          // Initial counts read
          await refreshCounts();
        } catch (error) {
          log(`Connection failed: ${error.message}`, 'error');
          cd48 = null;
        }
      }

      async function disconnect() {
        try {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            document.getElementById('autoRefresh').checked = false;
          }

          if (cd48) {
            await cd48.disconnect();
          }

          document.getElementById('statusDot').classList.remove('connected');
          document.getElementById('statusText').textContent = 'Disconnected';
          document.getElementById('connectBtn').textContent = 'Connect';
          document.getElementById('deviceStatus').textContent = 'Not connected';
          document.getElementById('firmware').textContent = '-';

          enableControls(false);
          resetCountsDisplay();
          log('Disconnected');
        } catch (error) {
          log(`Disconnect error: ${error.message}`, 'error');
        }
        cd48 = null;
      }

      function enableControls(enabled) {
        document.getElementById('clearBtn').disabled = !enabled;
        document.getElementById('ledBtn').disabled = !enabled;
        document.getElementById('settingsBtn').disabled = !enabled;
        document.getElementById('triggerSlider').disabled = !enabled;
        document.getElementById('impedanceSelect').disabled = !enabled;
        document.getElementById('dacSlider').disabled = !enabled;
        document.getElementById('autoRefresh').disabled = !enabled;
      }

      // Counts
      async function refreshCounts() {
        if (!cd48 || !cd48.isConnected()) return;

        try {
          const now = Date.now();
          const data = await cd48.getCounts(false);

          for (let i = 0; i < 8; i++) {
            const countEl = document.getElementById(`count${i}`);
            const rateEl = document.getElementById(`rate${i}`);
            countEl.textContent = formatNumber(data.counts[i]);

            // Calculate rate if we have previous data
            if (lastCounts && lastTime) {
              const dt = (now - lastTime) / 1000;
              const rate = data.counts[i] / dt;
              rateEl.textContent = `${formatNumber(Math.round(rate))} Hz`;
            }
          }

          document.getElementById('overflow').textContent =
            data.overflow === 0
              ? 'None'
              : `0x${data.overflow.toString(16).padStart(2, '0')}`;

          lastCounts = data.counts;
          lastTime = now;
        } catch (error) {
          log(`Error reading counts: ${error.message}`, 'error');
        }
      }

      async function clearCounts() {
        if (!cd48 || !cd48.isConnected()) return;

        try {
          await cd48.clearCounts();
          lastCounts = null;
          lastTime = null;
          log('Counts cleared');
          await refreshCounts();
        } catch (error) {
          log(`Error clearing counts: ${error.message}`, 'error');
        }
      }

      function resetCountsDisplay() {
        for (let i = 0; i < 8; i++) {
          document.getElementById(`count${i}`).textContent = '-';
          document.getElementById(`rate${i}`).textContent = '';
        }
        document.getElementById('overflow').textContent = '-';
        lastCounts = null;
        lastTime = null;
      }

      function toggleAutoRefresh() {
        const enabled = document.getElementById('autoRefresh').checked;

        if (enabled) {
          autoRefreshInterval = setInterval(refreshCounts, 1000);
          log('Auto-refresh enabled');
        } else {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          log('Auto-refresh disabled');
        }
      }

      // Controls
      function updateTriggerDisplay() {
        const value = parseInt(document.getElementById('triggerSlider').value);
        const voltage = (value / 255) * 4.08;
        document.getElementById('triggerValue').textContent =
          `${voltage.toFixed(2)} V`;
      }

      async function setTriggerLevel() {
        if (!cd48 || !cd48.isConnected()) return;

        const value = parseInt(document.getElementById('triggerSlider').value);
        const voltage = (value / 255) * 4.08;

        try {
          await cd48.setTriggerLevel(voltage);
          log(`Trigger level set to ${voltage.toFixed(2)} V`);
        } catch (error) {
          log(`Error setting trigger: ${error.message}`, 'error');
        }
      }

      async function setImpedance() {
        if (!cd48 || !cd48.isConnected()) return;

        const value = document.getElementById('impedanceSelect').value;

        try {
          if (value === '50ohm') {
            await cd48.setImpedance50Ohm();
            log('Impedance set to 50 Ohm');
          } else {
            await cd48.setImpedanceHighZ();
            log('Impedance set to High-Z');
          }
        } catch (error) {
          log(`Error setting impedance: ${error.message}`, 'error');
        }
      }

      function updateDacDisplay() {
        const value = parseInt(document.getElementById('dacSlider').value);
        const voltage = (value / 255) * 4.08;
        document.getElementById('dacValue').textContent =
          `${voltage.toFixed(2)} V`;
      }

      async function setDacVoltage() {
        if (!cd48 || !cd48.isConnected()) return;

        const value = parseInt(document.getElementById('dacSlider').value);
        const voltage = (value / 255) * 4.08;

        try {
          await cd48.setDacVoltage(voltage);
          log(`DAC voltage set to ${voltage.toFixed(2)} V`);
        } catch (error) {
          log(`Error setting DAC: ${error.message}`, 'error');
        }
      }

      async function testLeds() {
        if (!cd48 || !cd48.isConnected()) return;

        try {
          await cd48.testLeds();
          log('LED test initiated');
        } catch (error) {
          log(`Error testing LEDs: ${error.message}`, 'error');
        }
      }

      async function refreshSettings() {
        if (!cd48 || !cd48.isConnected()) return;

        try {
          const settings = await cd48.getSettings(true);
          log('Settings:\n' + settings);
        } catch (error) {
          log(`Error getting settings: ${error.message}`, 'error');
        }
      }

      // Utility
      function formatNumber(n) {
        if (n >= 1000000) {
          return (n / 1000000).toFixed(2) + 'M';
        } else if (n >= 1000) {
          return (n / 1000).toFixed(1) + 'k';
        }
        return n.toString();
      }

      // Tab Management
      function switchTab(tab) {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach((t) => t.classList.remove('active'));
        contents.forEach((c) => c.classList.remove('active'));

        if (tab === 'monitor') {
          tabs[0].classList.add('active');
          document.getElementById('monitorTab').classList.add('active');
          if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
          }
        } else if (tab === 'tracking') {
          tabs[1].classList.add('active');
          document.getElementById('trackingTab').classList.add('active');
          startTracking();
        }
      }

      // Chart Initialization
      function initChart() {
        const ctx = document.getElementById('rateChart').getContext('2d');

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#eee',
                  usePointStyle: true,
                  padding: 15,
                },
              },
              tooltip: {
                backgroundColor: 'rgba(26, 31, 58, 0.9)',
                titleColor: '#eee',
                bodyColor: '#eee',
                borderColor: '#e94560',
                borderWidth: 1,
              },
            },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'second',
                  displayFormats: {
                    second: 'HH:mm:ss',
                  },
                },
                ticks: {
                  color: '#888',
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)',
                },
              },
              y: {
                beginAtZero: true,
                ticks: {
                  color: '#888',
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)',
                },
                title: {
                  display: true,
                  text: 'Count Rate (Hz)',
                  color: '#eee',
                },
              },
            },
          },
        });
      }

      // Time Series Tracking
      function startTracking() {
        if (!cd48 || !cd48.isConnected()) {
          log('Connect to device first to start tracking', 'error');
          return;
        }

        if (!trackingInterval) {
          trackingInterval = setInterval(recordDataPoint, 1000);
          log('Time series tracking started');
        }
      }

      async function recordDataPoint() {
        if (!cd48 || !cd48.isConnected()) {
          if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
          }
          return;
        }

        try {
          const now = Date.now();
          const data = await cd48.getCounts(false);

          // Store timestamp
          trackingData.timestamps.push(now);

          // Calculate and store rates
          for (let i = 0; i < 8; i++) {
            let rate = 0;
            if (lastCounts && lastTime) {
              const dt = (now - lastTime) / 1000;
              const countDiff = data.counts[i] - lastCounts[i];
              rate = countDiff / dt;
            }
            trackingData.rates[i].push(rate);
            trackingData.counts[i].push(data.counts[i]);
          }

          lastCounts = data.counts;
          lastTime = now;

          // Limit data points (keep only data within time window * 2)
          const maxPoints = timeWindow * 2;
          if (trackingData.timestamps.length > maxPoints) {
            const removeCount = trackingData.timestamps.length - maxPoints;
            trackingData.timestamps.splice(0, removeCount);
            for (let i = 0; i < 8; i++) {
              trackingData.rates[i].splice(0, removeCount);
              trackingData.counts[i].splice(0, removeCount);
            }
          }

          updateChart();
          updateStats();
        } catch (error) {
          console.error('Error recording data point:', error);
        }
      }

      function updateChart() {
        if (!chart) return;

        const channelNames = [
          'Ch0 (A)',
          'Ch1 (B)',
          'Ch2 (C)',
          'Ch3 (D)',
          'Ch4 (A+B)',
          'Ch5 (A+C)',
          'Ch6 (A+D)',
          'Ch7 (B+C+D)',
        ];
        const channelColors = [
          '#e94560',
          '#3b82f6',
          '#4ade80',
          '#fbbf24',
          '#a855f7',
          '#ec4899',
          '#14b8a6',
          '#f97316',
        ];

        // Filter data by time window
        const cutoffTime = Date.now() - timeWindow * 1000;
        const filteredIndices = trackingData.timestamps
          .map((t, i) => ({ time: t, index: i }))
          .filter((item) => item.time >= cutoffTime);

        const labels = filteredIndices.map(
          (item) => trackingData.timestamps[item.index]
        );

        // Create datasets for visible channels
        const datasets = visibleChannels.map((ch) => ({
          label: channelNames[ch],
          data: filteredIndices.map(
            (item) => trackingData.rates[ch][item.index]
          ),
          borderColor: channelColors[ch],
          backgroundColor: channelColors[ch] + '33',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
        }));

        chart.data.labels = labels;
        chart.data.datasets = datasets;
        chart.update('none'); // Update without animation for smooth real-time updates
      }

      function updateStats() {
        document.getElementById('totalPoints').textContent =
          trackingData.timestamps.length;

        if (trackingData.timestamps.length > 0) {
          const duration =
            (trackingData.timestamps[trackingData.timestamps.length - 1] -
              trackingData.timestamps[0]) /
            1000;
          if (duration < 60) {
            document.getElementById('duration').textContent =
              Math.round(duration) + 's';
          } else if (duration < 3600) {
            document.getElementById('duration').textContent =
              (duration / 60).toFixed(1) + 'm';
          } else {
            document.getElementById('duration').textContent =
              (duration / 3600).toFixed(1) + 'h';
          }

          // Calculate average and peak for Ch0
          const ch0Rates = trackingData.rates[0].filter((r) => r > 0);
          if (ch0Rates.length > 0) {
            const avg = ch0Rates.reduce((a, b) => a + b, 0) / ch0Rates.length;
            const peak = Math.max(...ch0Rates);
            document.getElementById('avgRate').textContent =
              formatNumber(Math.round(avg)) + ' Hz';
            document.getElementById('peakRate').textContent =
              formatNumber(Math.round(peak)) + ' Hz';
          }
        }
      }

      function toggleChannel(ch) {
        const chip = document.querySelector(`[data-channel="${ch}"]`);
        const index = visibleChannels.indexOf(ch);

        if (index > -1) {
          visibleChannels.splice(index, 1);
          chip.classList.remove('active');
        } else {
          visibleChannels.push(ch);
          chip.classList.add('active');
        }

        updateChart();
      }

      function updateTimeWindow() {
        timeWindow = parseInt(document.getElementById('timeWindow').value);
        updateChart();
      }

      function clearHistory() {
        trackingData = {
          timestamps: [],
          rates: Array(8)
            .fill(null)
            .map(() => []),
          counts: Array(8)
            .fill(null)
            .map(() => []),
        };
        lastCounts = null;
        lastTime = null;
        updateChart();
        updateStats();
        log('Tracking history cleared');
      }

      function exportData() {
        if (trackingData.timestamps.length === 0) {
          log('No data to export', 'error');
          return;
        }

        // Create CSV content
        let csv = 'Timestamp,';
        const channelNames = [
          'Ch0_A',
          'Ch1_B',
          'Ch2_C',
          'Ch3_D',
          'Ch4_AB',
          'Ch5_AC',
          'Ch6_AD',
          'Ch7_BCD',
        ];

        // Header
        for (let i = 0; i < 8; i++) {
          csv += `${channelNames[i]}_Rate_Hz,${channelNames[i]}_Count,`;
        }
        csv = csv.slice(0, -1) + '\n';

        // Data rows
        for (let j = 0; j < trackingData.timestamps.length; j++) {
          const date = new Date(trackingData.timestamps[j]);
          csv += date.toISOString() + ',';
          for (let i = 0; i < 8; i++) {
            csv += `${trackingData.rates[i][j].toFixed(2)},${trackingData.counts[i][j]},`;
          }
          csv = csv.slice(0, -1) + '\n';
        }

        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cd48_data_${new Date().toISOString().replace(/:/g, '-')}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        log('Data exported to CSV');
      }
    </script>
  </body>
</html>
